{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "USDT Payment" %} - {{ wishlist_item.title }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">{% trans "USDT Payment" %}</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5 class="alert-heading">{% trans "Payment Instructions" %}</h5>
                        <p>{% trans "Please follow these steps to complete USDT payment:" %}</p>
                        <ol>
                            <li>{% trans "Open your USDT wallet (such as Binance, Coinbase, etc.)" %}</li>
                            <li>{% trans "Transfer USDT to the address below" %}</li>
                            <li>{% trans "Copy and submit the transaction hash (TxID)" %}</li>
                        </ol>
                    </div>
                    
                    <div class="product-summary mb-4 p-3 border rounded">
                        <div class="d-flex justify-content-between">
                            <h5 class="mb-0">{{ wishlist_item.title }}</h5>
                            <span class="badge bg-success p-2">{{ payment.amount }} {{ payment.currency }}</span>
                        </div>
                    </div>
                    
                    <div class="payment-info mb-4 p-4 border rounded bg-light">
                        <h5 class="mb-3">{% trans "Payment Information" %}</h5>
                        
                        <div class="mb-3">
                            <label class="form-label">{% trans "Network" %}</label>
                            <div class="form-control bg-white">{{ usdt_details.network|upper }}</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">{% trans "Receiving Address" %}</label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-white" value="{{ usdt_details.wallet_address }}" readonly id="wallet-address">
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('wallet-address')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">{% trans "Payment Amount" %}</label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-white" value="{{ payment.amount }}" readonly id="payment-amount">
                                <span class="input-group-text">{{ payment.currency }}</span>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('payment-amount')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <small class="text-muted">{% trans "Please ensure the transfer amount matches exactly" %}</small>
                        </div>
                        
                        {% if usdt_details.qr_code %}
                            <div class="text-center mb-3">
                                <p>{% trans "Or scan the QR code" %}</p>
                                <img src="{{ usdt_details.qr_code.url }}" alt="QR Code" class="img-fluid" style="max-width: 200px;">
                            </div>
                        {% endif %}
                    </div>
                    
                    <form method="post" class="mb-4">
                        {% csrf_token %}
                        <h5 class="mb-3">{% trans "Submit Transaction Information" %}</h5>
                        
                        <div class="mb-3">
                            <label for="transaction_hash" class="form-label">{% trans "Transaction Hash (TxID)" %}*</label>
                            <input type="text" class="form-control" id="transaction_hash" name="transaction_hash" required>
                            <div class="form-text">{% trans "Please enter the transaction hash you received after completing the transfer in your wallet" %}</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sender_address" class="form-label">{% trans "Sender Address" %}</label>
                            <input type="text" class="form-control" id="sender_address" name="sender_address">
                            <div class="form-text">{% trans "Optional: Your wallet address from which you sent USDT" %}</div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                {% trans "Submit Transaction Information" %}
                            </button>
                        </div>
                    </form>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'payment_method_list' wishlist_item_id=wishlist_item.id %}" class="btn btn-outline-secondary">
                            {% trans "Change Payment Method" %}
                        </a>
                        <a href="{% url 'payment_status' payment_id=payment.id %}" class="btn btn-info">
                            {% trans "Check Payment Status" %}
                        </a>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        {% trans "Payment ID:" %} {{ payment.id }}<br>
                        {% trans "Created at:" %} {{ payment.created_at|date:"Y-m-d H:i:s" }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        element.select();
        element.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        // Show copy success notification
        const originalButtonText = element.nextElementSibling.innerHTML;
        element.nextElementSibling.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            element.nextElementSibling.innerHTML = originalButtonText;
        }, 2000);
    }
    
    // Auto-refresh payment status
    let checkInterval;
    
    function checkPaymentStatus() {
        fetch('/payment/api/status/{{ payment.id }}/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'completed') {
                // Payment successful, redirect to success page
                window.location.href = "{% url 'payment_success' wishlist_item_id=wishlist_item.id %}";
            }
        })
        .catch(error => console.error('Error checking payment status:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Check payment status every 30 seconds
        checkInterval = setInterval(checkPaymentStatus, 30000);
    });
    
    window.addEventListener('beforeunload', function() {
        // Clear the timer
        clearInterval(checkInterval);
    });
</script>
{% endblock %} 